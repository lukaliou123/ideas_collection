# 标签自动合并功能使用指南

## 概述

标签自动合并功能是项目定时任务系统的一部分，用于自动识别和合并相似的标签，减少标签冗余，提高标签系统的整洁性和可用性。

## 功能特点

- **自动识别相似标签**：基于标签名称的相似度算法，自动识别高度相似的标签
- **智能合并策略**：将相似标签合并到最早创建的标签中，保留历史记录
- **别名保存**：被合并的标签名称会保存为主标签的别名，不丢失信息
- **定时执行**：每天自动执行，保持标签系统的整洁
- **手动执行**：支持手动触发，方便测试和维护

## 定时任务配置

### 执行时间安排

标签自动合并任务已集成到项目的定时任务系统中，执行顺序如下：

1. **10:00** - HackerNews数据收集
2. **每24小时** - 产品处理任务（AI分析）
3. **10:20** - 🆕 **标签自动合并** （新增功能）
4. **10:30** - 精选产品更新

### 自动启动

当启动定时任务调度器时，标签合并任务会自动注册：

```bash
# 启动完整的定时任务调度器
python scripts/run_scheduler.py --daemon
```

## 手动执行方式

### 1. 通过调度器脚本执行

```bash
# 单次执行标签合并任务
python scripts/run_scheduler.py --run-once --task tags
```

### 2. 通过专用脚本执行

```bash
# 使用默认阈值（0.90）执行合并
python scripts/auto_merge_tags.py

# 使用自定义相似度阈值
python scripts/auto_merge_tags.py --threshold 0.85

# 仅查看相似标签，不执行合并
python scripts/auto_merge_tags.py --show-similar --threshold 0.80

# 试运行模式（暂未完全实现）
python scripts/auto_merge_tags.py --dry-run
```

### 3. 通过manage_tags.py脚本执行

```bash
# 执行标签自动合并
python scripts/manage_tags.py --auto-merge --threshold 0.90
```

## 相似度阈值说明

- **0.95-1.0**：非常高的相似度，几乎完全相同的标签
- **0.90-0.95**：高相似度，推荐用于自动合并（默认值：0.90）
- **0.80-0.90**：中等相似度，建议人工审核后合并
- **0.70-0.80**：较低相似度，通常不建议自动合并

## 合并策略

### 主标签选择
- 优先选择**创建时间最早**的标签作为主标签
- 保留主标签的所有属性和关联关系

### 次要标签处理
- 将次要标签的名称添加到主标签的`aliases`字段
- 将次要标签的产品关联转移到主标签
- 删除次要标签记录

### 示例
```
合并前：
- 标签1: "web app" (ID: 1, 创建时间: 2024-01-01)
- 标签2: "webapp" (ID: 2, 创建时间: 2024-01-02)
- 标签3: "web-app" (ID: 3, 创建时间: 2024-01-03)

合并后：
- 主标签: "web app" (ID: 1)
  - aliases: ["webapp", "web-app"]
  - 包含所有原本关联到标签2和标签3的产品
```

## 监控和日志

### 日志输出
标签合并任务会输出详细的日志信息：

```
2024-01-15 10:20:00 - INFO - 开始执行标签自动合并任务...
2024-01-15 10:20:01 - INFO - Merging 2 tags into 'web app' (ID: 1) with threshold 0.9
2024-01-15 10:20:02 - INFO - 标签自动合并任务执行完成，合并了 2 个标签
```

### 查看合并结果
可以通过以下方式查看合并结果：

```bash
# 查看所有标签及其别名
python scripts/list_tags.py

# 查看特定标签的详细信息
python scripts/manage_tags.py --show-tag-details
```

## 配置选项

### 环境变量
标签合并功能受以下环境变量控制：

```bash
# 是否启用AI分析（标签合并需要此功能启用）
ENABLE_AI_ANALYSIS=True

# 是否启用定时任务调度器
ENABLE_SCHEDULER=True
```

### 自定义阈值
可以通过修改`TaskService.run_tag_auto_merge()`方法中的阈值来调整自动合并的敏感度：

```python
# 在 app/services/task_service.py 中
result = TagService.auto_merge_similar_tags(db, threshold=0.90)  # 可调整此值
```

## 注意事项

1. **不可逆操作**：标签合并是不可逆的操作，被合并的标签会被永久删除
2. **数据备份**：建议在执行大规模合并前备份数据库
3. **阈值选择**：过低的阈值可能导致不相关标签被错误合并
4. **性能影响**：大量标签的相似度计算可能需要一定时间

## 故障排除

### 常见问题

1. **任务未执行**
   - 检查`ENABLE_AI_ANALYSIS`是否为`True`
   - 确认定时任务调度器正在运行

2. **合并数量为0**
   - 检查数据库中是否有足够的标签
   - 尝试降低相似度阈值

3. **执行出错**
   - 查看日志文件获取详细错误信息
   - 确认数据库连接正常

### 调试命令

```bash
# 查看当前所有定时任务状态
python scripts/run_scheduler.py --show-jobs

# 测试标签相似度计算
python scripts/auto_merge_tags.py --show-similar --threshold 0.70
```

## 更新日志

- **v1.0** - 初始版本，支持基本的标签自动合并功能
- **v1.1** - 添加定时任务集成，支持每日自动执行
- **v1.2** - 增加手动执行脚本和详细日志输出 